sys_import turi.fx.base
sys_import turi.fx.tableview

let _menu_bar = java_class("javafx.scene.control.MenuBar");
let _menu = java_class("javafx.scene.control.Menu");
let _menu_item = java_class("javafx.scene.control.MenuItem");
let _file_chooser = java_class("javafx.stage.FileChooser");
let _file_chooser_ext_filter = java_class("javafx.stage.FileChooser$ExtensionFilter");
let _tab_pane = java_class("javafx.scene.control.TabPane");
let _tab = java_class("javafx.scene.control.Tab");

/**
 * Creates a menu bar with a File menu containing an Open item.
 *
 * The Open menu item opens a file chooser dialog to select a Turicum program.
 *
 * @param on_file_selected a callable invoked with the selected file path when a file is chosen
 * @return the created MenuBar
 */
fn create_debugger_menu_bar(on_file_selected) {
    let menu_bar = _menu_bar();

    let file_menu = _menu("File");

    let open_item = _menu_item("Open");
    open_item.setOnAction(event_handler(fn(event) {
        let file_chooser = _file_chooser();
        file_chooser.setTitle("Select Turicum Program to Debug");

        let filter = _file_chooser_ext_filter("Turicum Files (*.turi)", ["*.turi"]);
        file_chooser.getExtensionFilters().add(filter);

        let file = file_chooser.showOpenDialog(fx_stage);
        if file != none {
            let file_path = file.getAbsolutePath();
            on_file_selected(file_path);
        }
    }));

    file_menu.getItems().add(open_item);
    menu_bar.getMenus().add(file_menu);

    return menu_bar;
}

/**
 * Creates a TabPane with tabs for Code, Output, and other debugger views.
 *
 * @return the created TabPane
 */
fn create_debugger_tab_pane() {
    let tab_pane = _tab_pane();

    let code_tab = _tab();
    code_tab.setText("Code");
    code_tab.setContent(text_area());
    code_tab.setClosable(false);

    let output_tab = _tab();
    output_tab.setText("Output");
    output_tab.setContent(text_area());
    output_tab.setClosable(false);

    let stack_tab = _tab();
    stack_tab.setText("Stack");
    stack_tab.setContent(text_area());
    stack_tab.setClosable(false);

    tab_pane.getTabs().add(code_tab);
    tab_pane.getTabs().add(output_tab);
    tab_pane.getTabs().add(stack_tab);

    return tab_pane;
}

/**
 * Creates a toolbar for debugger controls.
 *
 * @param on_step a callable invoked when the Step button is clicked
 * @param on_continue a callable invoked when the Continue button is clicked
 * @param on_stop a callable invoked when the Stop button is clicked
 * @return the created toolbar HBox
 */
fn create_debugger_toolbar(on_step, on_continue, on_stop) {
    let toolbar = hbox(5);
    toolbar.setStyle("-fx-padding: 5; -fx-border-bottom: 1 solid #cccccc;");

    toolbar.getChildren().add(create_button("Step", on_step));
    toolbar.getChildren().add(create_button("Continue", on_continue));
    toolbar.getChildren().add(create_button("Stop", on_stop));

    return toolbar;
}

/**
 * Creates the bottom panel with variables table.
 *
 * @return the created VBox containing the variables table
 */
fn create_debugger_variables_panel() {
    let bottom_container = vbox(5);
    bottom_container.setStyle("-fx-border-top: 1 solid #cccccc; -fx-padding: 5;");

    let title = label("Variables:");
    bottom_container.getChildren().add(title);

    let columns = [
        { name: "Name", property: "name", width: 150 },
        { name: "Value", property: "value", width: 300 },
        { name: "Type", property: "type", width: 100 }
    ];

    let var_table = create_table_view(columns);
    var_table.setId("variables_table");
    bottom_container.getChildren().add(var_table);

    return bottom_container;
}

/**
 * Creates a complete debugger window layout.
 *
 * @param on_file_selected a callable invoked with the selected file path
 * @param on_step a callable invoked when the Step button is clicked
 * @param on_continue a callable invoked when the Continue button is clicked
 * @param on_stop a callable invoked when the Stop button is clicked
 * @return a map with keys: menu_bar, toolbar, tab_pane, variables_panel, root
 */
fn create_debugger_layout(on_file_selected, on_step, on_continue, on_stop) {
    let menu_bar = create_debugger_menu_bar(on_file_selected);
    let toolbar = create_debugger_toolbar(on_step, on_continue, on_stop);
    let tab_pane = create_debugger_tab_pane();
    let variables_panel = create_debugger_variables_panel();

    let root = java_class("javafx.scene.layout.BorderPane")();
    root.setTop(vbox(
        [
            menu_bar,
            toolbar
        ]
    ));
    root.setCenter(tab_pane);
    root.setBottom(variables_panel);

    return {
        menu_bar: menu_bar,
        toolbar: toolbar,
        tab_pane: tab_pane,
        variables_panel: variables_panel,
        root: root
    };
}

export_all();